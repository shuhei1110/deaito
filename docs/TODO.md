# 開発TODO（商用版移行）

このドキュメントは、モック版から Supabase ベースの商用版へ移行するための実行タスク一覧です。  
優先度は **P0 > P1 > P2**。依存関係は `Depends on` に記載しています。

## 進め方の前提

- まずは「動く最小商用版（MVP）」を作る
- UI改修より先に、認証・DB・Storage・RLSの土台を固める
- 画面は既存の7ページを活かし、データ接続を優先

## 現在の完了状態（2026-02-24）

- 完了: T01, T02, T03, T04, T05
- 次に着手: T06
- 未着手: T07 以降

## タスク一覧

| ID | Status | Priority | タスク | Depends on | 完了条件 |
|---|---|---|---|---|---|
| T01 | ✅ 完了 | P0 | Supabaseプロジェクト作成と環境変数整備 | - | Supabase URL/Anon Key/Service Key を環境ごとに管理できる |
| T02 | ✅ 完了 | P0 | `supabase/schema.sql` を適用し、型・テーブル・RLS・Storage bucketを構築 | T01 | SQL適用が成功し、主要テーブルとRLSポリシーが有効 |
| T03 | ✅ 完了 | P0 | Next.js に Supabaseクライアント（browser/server）を実装 | T01 | `lib/supabase/*` でクライアント生成を共通化できる |
| T04 | ✅ 完了 | P0 | 認証（サインイン/サインアップ/サインアウト/セッション維持）実装 | T03 | ログイン状態で画面アクセス制御ができる |
| T05 | ✅ 完了 | P0 | 初回ログイン時の `profiles` 自動作成フロー実装 | T04, T02 | 認証ユーザーに対応する `profiles` レコードが必ず作成される |
| T06 | ▶ 次着手 | P0 | アルバム一覧 (`/albums`) をDB接続（一覧/検索/作成/参加） | T05, T02 | モック配列を使わずDBから表示・作成できる |
| T07 | ⏳ 未着手 | P0 | アルバム詳細 (`/album/[id]`) をDB接続（イベント/ギャラリー/メンバー） | T06 | タブ内データがすべてDB由来になる |
| T08 | ⏳ 未着手 | P0 | イベント詳細のアップロードを Storage + `media_assets` 接続 | T07, T02 | 画像/動画がStorageに保存され、DBメタデータと一致 |
| T09 | ⏳ 未着手 | P0 | 招待状 (`/invitations`) をDB接続（送信/一覧/応答） | T05, T02 | 招待状の状態遷移（pending→accepted/declined）が反映 |
| T10 | ⏳ 未着手 | P0 | つながり (`/album/[id]/connections`) をDB接続 | T07, T02 | 接続グラフの元データが `connections` テーブルになる |
| T11 | ⏳ 未着手 | P1 | TopBar検索をDB接続（アルバム/ユーザー/イベント） | T06, T07 | 検索結果が実データに切替 |
| T12 | ⏳ 未着手 | P1 | 未実装ルート追加（`/settings`, `/notifications`, `/help`） | T04 | 遷移先で404が出ない |
| T13 | ⏳ 未着手 | P1 | APIアクセス制御見直し（RLS前提で不要APIを削減、必要ならRoute Handler最小化） | T06, T07, T09 | データアクセス経路が整理され、責務が明確 |
| T14 | ⏳ 未着手 | P1 | 監視と運用（エラーログ、監査、バックアップ方針）を定義 | T08, T09 | 障害時の確認手順と復旧方針が文書化 |
| T15 | ⏳ 未着手 | P2 | パフォーマンス最適化（画像サムネイル、クエリ最適化、ページング） | T08, T11 | 主要画面の体感速度が改善 |
| T16 | ⏳ 未着手 | P2 | E2Eテスト導入（主要フロー: ログイン→アルバム→アップロード→招待） | T10, T12 | 主要業務フローを自動回帰できる |
| T17 | ⏳ 未着手 | P1 | アップロード容量制限（1ユーザー合計256MB）を実装 | T08, T13 | 上限超過時にアップロードがサーバー側で拒否される |
| T18 | ⏳ 未着手 | P1 | 容量制限の整合性運用（削除時減算/再集計ジョブ）を実装 | T17 | `used_bytes` と実ファイル容量の差分を継続的に補正できる |
| T19 | ⏳ 未着手 | P2 | 外部ストレージ移行設計（S3/R2）を作成（Future Work） | T18 | 保存先を差し替えるための移行計画と影響範囲が確定 |
| T20 | ⏳ 未着手 | P2 | 外部ストレージ移行を実装（S3/R2 + 署名URL） | T19 | メディア本体を外部保存しつつ既存機能が維持される |

## 依存関係（簡易フロー）

```text
T01 -> T02 -> T03 -> T04 -> T05
T05 -> T06 -> T07 -> (T08, T10)
T05 -> T09
(T06, T07) -> T11
T04 -> T12
(T06, T07, T09) -> T13
(T08, T09) -> T14
(T08, T11) -> T15
(T10, T12) -> T16
T08 -> T17 -> T18
T18 -> T19 -> T20
```

## まず着手する順番（推奨）

1. T01〜T05（基盤）
2. T06〜T10（主要画面の実データ化）
3. T11〜T14（運用品質）
4. T15〜T16（最適化・自動化）

## 補足

- 本プロジェクトは現状モックデータ中心のため、**「UI追加」より「既存UIのデータ接続」**の方が価値が高い
- 迷った場合は、ユーザーストーリーの主線（ホーム→アルバム→イベント→招待）を優先する
