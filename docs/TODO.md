# 開発TODO（商用版移行）

このドキュメントは、モック版から Supabase ベースの商用版へ移行するための実行タスク一覧です。
優先度は **P0 > P1 > P2**。依存関係は `Depends on` に記載しています。

## 進め方の前提

- まずは「動く最小商用版（MVP）」を作る
- UI改修より先に、認証・DB・Storage・RLSの土台を固める
- 画面は既存の7ページを活かし、データ接続を優先

## 現在の完了状態（2026-03-01）

- 完了: T01, T02, T03, T04, T05, T05a, T06, T06a, T06b, T07, T08 (T17含む), T09, T10, T11, T12, T12a, T12b, T12c, T13, T14, T15, T18, T19, T20, T21, T22, T23, T24, T25, T26, T27, T28, T29, T30, T31, T32, T33, T34
- 追加実装: プロフィール画像アップロード機能（GCS連携）、アルバムメンバーのアバター署名付きURL対応、アルバム参加フローリファクタ（招待コード直接入力+検索フィルタ強化）
- 次に着手: 未定
- 未着手: T16

## タスク一覧

| ID | Status | Priority | タスク | Depends on | 完了条件 |
|---|---|---|---|---|---|
| T01 | ✅ 完了 | P0 | Supabaseプロジェクト作成と環境変数整備 | - | Supabase URL/Anon Key/Service Key を環境ごとに管理できる |
| T02 | ✅ 完了 | P0 | `supabase/schema.sql` を適用し、型・テーブル・RLSを構築 | T01 | SQL適用が成功し、主要テーブルとRLSポリシーが有効 |
| T03 | ✅ 完了 | P0 | Next.js に Supabaseクライアント（browser/server）を実装 | T01 | `lib/supabase/*` でクライアント生成を共通化できる |
| T04 | ✅ 完了 | P0 | 認証（サインイン/サインアップ/サインアウト/セッション維持）実装 | T03 | ログイン状態で画面アクセス制御ができる |
| T05 | ✅ 完了 | P0 | 初回ログイン時の `profiles` 自動作成フロー実装 | T04, T02 | 認証ユーザーに対応する `profiles` レコードが必ず作成される |
| T05a | ✅ 完了 | P0 | 初回登録時のプロフィール初期設定ページ (`/auth/setup`) | T05 | 新規ユーザーがユーザー名・表示名を設定してからホームに遷移する |
| T06 | ✅ 完了 | P0 | アルバム一覧 (`/albums`) をDB接続（一覧/検索/作成/参加） | T05, T02 | モック配列を使わずDBから表示・作成できる |
| T06a | ✅ 完了 | P0 | アルバム参加に招待コードを必須化 | T06 | コードなしでは参加不可。オーナーはコード確認・再生成が可能 |
| T06b | ✅ 完了 | P0 | 招待コードなしでの参加リクエスト + オーナー承認フロー | T06a | コード未所持ユーザーがリクエスト送信→オーナーが承認/拒否できる |
| T07 | ✅ 完了 | P0 | アルバム詳細 (`/album/[id]`) をDB接続（イベント/ギャラリー/メンバー） + オーナー権限UI | T06a, T06b | タブ内データがすべてDB由来。オーナーは招待コード確認・再生成、メンバー管理が可能 |
| T08 | ✅ 完了 | P0 | イベント詳細のアップロードを GCP Cloud Storage + `media_assets` 接続（T17容量制限も統合実装済み） | T07, T02 | 画像/動画がGCSに保存され、DBメタデータと一致。署名付きURL(読み書き)、容量制限256MB/user |
| T09 | ✅ 完了 | P0 | 招待状をDB接続。アルバム招待はアルバム一覧+ホームで表示、`/invitations`はつなぐ専用（T21で実装予定） | T06b, T07 | アルバム招待の送受信・承認/辞退がDB経由で動作。招待状ページはつなぐ用の空状態 |
| T10 | ✅ 完了 | P0 | つながり (`/album/[id]/connections`) をDB接続 + 重み付きスコアリング | T07, T02 | 接続グラフの元データが `connections` テーブルになる。閲覧追跡(`album_views`)、重み付きポイント算式(`sqrt(unique_users)×ln(1+total)×momentum`)、オーナー閾値設定を実装 |
| T11 | ✅ 完了 | P1 | TopBar検索をDB接続（アルバム/ユーザー/イベント） | T06a, T07 | 検索結果が実データに切替 |
| T12 | ✅ 完了 | P1 | TopBar右上プロフィールをDB接続（表示名・アバター表示、ログアウト動作） | T05a | TopBarのアバター・名前がログインユーザーのDB情報を反映する |
| T12a | ✅ 完了 | P1 | `/settings` ページ実装（アカウント設定・パスワード変更・テーマ切替） | T12 | 設定画面で基本的なアカウント操作ができる |
| T12b | ✅ 完了 | P1 | `/notifications` ページ実装（通知一覧のDB接続・既読管理） | T12, T09 | 通知がDB由来になり、未読/既読の状態管理ができる |
| T12c | ✅ 完了 | P2 | `/help` ページ実装（FAQ・お問い合わせフォーム） | T04 | FAQ（アカウント/アルバム/メディア/つなぐポイント 4カテゴリ11問）とお問い合わせフォーム（`support_inquiries`テーブルにDB保存）を実装。プロフィールメニューにヘルプリンク追加 |
| T13 | ✅ 完了 | P1 | APIアクセス制御見直し（RLS前提で不要APIを削減、Route Handler最小化） | T06a, T07, T09 | Route Handler を11→5に削減（media/search/notifications の6件を Server Actions に移行）。media_views/notifications の RLS 有効化、media_reactions の DELETE ポリシー追加。admin client の不要な使用を server client に置換 |
| T14 | ✅ 完了 | P1 | 監視と運用（エラーログ、監査、バックアップ方針）を定義 | T08, T09 | 運用ランブック(`docs/operations/runbook.md`)を作成: システム構成概要、監視項目(Vercel/Supabase/GCS)、障害対応フロー(P0-P2エスカレーション)、よくある障害5パターンの確認・復旧手順、バックアップ方針(DB/GCS/コード)、定期運用タスク(日次/週次/月次)、ログ確認方法(エラータグ一覧)。Error Boundary(`app/error.tsx`, `app/global-error.tsx`)とヘルスチェック(`/api/health`)も追加 |
| T15 | ✅ 完了 | P2 | パフォーマンス最適化（クエリ最適化、ページング） | T08, T11 | N+1クエリ解消: いいね数・コメント数をメディア1件ずつ個別クエリ(2N回)→`.in()`バッチ取得(2回)に削減。ギャラリーページネーション: `getMediaByAlbumId`に`limit/offset`+全件数返却を追加、初期20件ロード+「もっと見る」ボタンで追加読み込み。画像に`loading="lazy"`追加 |
| T16 | ⏳ 未着手 | P2 | E2Eテスト導入（主要フロー: ログイン→アルバム→アップロード→招待） | T10, T12 | 主要業務フローを自動回帰できる |
| T17 | ✅ 完了 | P1 | アップロード容量制限（1ユーザー合計256MB）を実装 ※T08に統合済み | T08, T13 | 上限超過時にアップロードがサーバー側で拒否される |
| T18 | ✅ 完了 | P1 | 容量制限の整合性運用（削除時減算/再集計ジョブ）を実装 | T17 | 削除時減算はT29で実装済み。`reconcile_storage_quotas()` DB関数で `media_assets.size_bytes` の実合計から `used_bytes` を再集計。pg_cron で日次スケジュール可能。admin Server Action で手動トリガーも可能 |
| T19 | ✅ 完了 | P1 | ホームのアクティビティフィードをDB接続 | T07, T08 | `activity-timeline.tsx` のモック配列を廃止し、実際のアップロード/参加等のイベントを表示 |
| T20 | ✅ 完了 | P1 | つなぐポイント機能をDB接続 | T10 | `tsunagu-mini-card.tsx`, `connection-graph.tsx` は T10 で実データ化済み。`tsunagu-points-carousel.tsx` のモック廃止完了（`getCarouselAlbumPoints()` でアルバム毎のポイント・7日間トレンドを取得しprops化） |
| T21 | ✅ 完了 | P2 | AI同窓会提案機能をDB接続 | T10, T09 | モック提案2件を廃止し、ユーザー参加アルバムから同窓会提案をオンザフライ生成。`lib/supabase/reunion-proposals.ts`で`generateReunionProposals()`を実装（メンバー3人以上・アクティビティありのアルバムを対象、マッチ度=つなぐポイント達成率）。メンバー毎のアクティビティラベル生成（写真好き/いいね上手/コメント上手/アクティブ）。`/invitations`ページで提案表示、0件時はプレースホルダー維持。モック用アバター画像5件も削除 |
| T22 | ✅ 完了 | P1 | `/user/:id` ユーザー詳細ページ実装 | T05a, T07 | `user-profile.tsx` のモックを廃止。他ユーザーのプロフィールとアルバム共有状況を表示 |
| T23 | ✅ 完了 | P1 | ダイアログ/モーダルUIデザイン改善 | T06b | ベースDialog に ios-card glassmorphism を統合。全17ダイアログの冗長クラス除去（DRY化）。オーバーレイに backdrop-blur 追加。招待コード表示の縦書きバグ修正（whitespace-nowrap）。iOS classes を @layer components に移動して cascade 正規化。設定ページ削除ダイアログの不統一も自動修正 |
| T24 | ✅ 完了 | P1 | 日付ピッカーUIのカスタム化 | T07 | イベント作成等の日付選択をデフォルトの`<input type="date">`からアプリデザインに合ったカスタムDatePickerに置き換え |
| T25 | ✅ 完了 | P1 | アルバム内の参加リクエスト通知導線 + 参加フローリファクタ | T06b, T07, T12b | オーナーへのjoin_request通知、?tab=membersディープリンク、メンバータブ赤ドットバッジ。さらに参加フローを2導線に分離: 招待コード直接入力(逆引き参加) + 条件検索(カテゴリ/年/作成者表示)+リクエスト送信 |
| T26 | ✅ 完了 | P0 | 利用規約ページ作成 + サインアップ時の同意フロー | T04 | `/terms` に利用規約を掲載。サインアップ（メール/Google）で同意チェックボックス必須。setup画面でも同意必須。middleware でセットアップ未完了ユーザーの直接アクセスをブロック |
| T27 | ✅ 完了 | P1 | プロフィール画面にストレージ使用量表示 | T08, T12 | ユーザープロフィールまたは設定画面に現在のアップロード使用量と残り容量をプログレスバー付きで表示（`user_storage_quotas` テーブル参照） |
| T28 | ✅ 完了 | P1 | メディアビューワー実装（写真・動画の全画面表示） | T08 | ギャラリーの写真/動画タップで全画面ビューワーが開く。スワイプで前後移動、ピンチズーム、動画再生、撮影日時・イベント名・いいね数の表示。閉じるボタンで戻る |
| T29 | ✅ 完了 | P1 | メディア削除機能 | T08, T18 | アップロード者本人またはアルバムオーナーがメディアを削除できる。GCSオブジェクト削除 + `media_assets`行削除 + `used_bytes`減算を一括実行。確認ダイアログ付き |
| T30 | ✅ 完了 | P2 | favicon設定 | - | `public/favicon.ico`を配置し、`app/layout.tsx`の`metadata.icons`に追加。ライト/ダークモード用PNG、SVG、Apple Touch Iconと併せて5種のアイコンを設定 |
| T31 | ✅ 完了 | P2 | `/public` ディレクトリの整理 | ハードコーディング全廃後 | 72ファイル（約191MB）を削除。gallery画像46件、未使用モック人物画像10件、イベント写真4件、プレースホルダー6件、プロフィール画像1件、AI同窓会提案用アバター4件+placeholder.svgを削除。残り4ファイル（favicon関連のみ）|
| T32 | ✅ 完了 | P1 | オーナーによるアルバム削除機能 | T07 | アルバムオーナーがアルバム設定からアルバムを削除できる。確認ダイアログ付き。関連データ（メンバー・イベント・メディア・GCSオブジェクト）も連鎖削除 |
| T33 | ✅ 完了 | P1 | つなぐポイント確認ページのAnalyticsダッシュボード化 | T10, T20 | `/album/[id]/connections` のポイント確認UIをVercel Analytics風のダッシュボードに刷新。期間フィルタ（1日/1週間/1ヶ月/全期間）、折れ線グラフにホバーツールチップ（日付+値）、プルダウンで表示指標を切替（ポイント/閲覧数/いいね数/アップロード数/コメント数）、サマリーカード（現在値+前期間比の増減率）を表示 |
| T34 | ✅ 完了 | P1 | 検索カテゴリ選択のカスタムSelect化 | T25 | アルバム検索のカテゴリ選択プルダウンがブラウザネイティブの`<select>`でアプリのトンマナと合っていない。shadcn/ui の Select コンポーネント（@radix-ui/react-select）に置き換えてデザインを統一する |

## T06a 詳細設計

### 方針

- アルバム作成時にランダムな招待コードを自動生成（`gen_random_bytes(5)` → 10桁hex）
- 検索でアルバムは見つかるが、参加には招待コードの入力が必要
- オーナー/管理者は招待コードの確認・再生成が可能

### DB変更

```sql
ALTER TABLE public.albums
  ADD COLUMN join_code text
    NOT NULL
    DEFAULT encode(gen_random_bytes(5), 'hex')
    UNIQUE;
```

### 参加フロー

```
検索 → アルバム発見 → 「招待コードを入力」ダイアログ
  → コード一致 → 即参加（membership_status = 'active'）
  → コード不一致 → エラー表示
```

### 実装スコープ

1. schema.sql に `join_code` カラム追加 + マイグレーションSQL作成
2. `joinAlbum()` でコード照合を必須化
3. 検索結果UIに「招待コードを入力」ダイアログ追加
4. アルバム作成後にコードをオーナーに表示（コピー可能）
5. アルバム詳細/設定でオーナーがコード確認・再生成できるUI（T07と併せて実装可）

## 依存関係（簡易フロー）

```text
T01 -> T02 -> T03 -> T04 -> T05
T05 -> T06 -> T06a -> T06b -> T07 -> (T08, T10)
T06b -> T09 (招待コード共有・参加リクエスト承認と連携)
T07 -> T09
(T06a, T07) -> T11
T05a -> T12 -> T12a
(T12, T09) -> T12b
T04 -> T12c
(T06a, T07, T09) -> T13
(T08, T09) -> T14
(T08, T11) -> T15
(T10, T12a) -> T16
T08 -> T17 -> T18
(T07, T08) -> T19
T10 -> T20
(T10, T09) -> T21
(T05a, T07) -> T22
T04 -> T26
(T08, T12) -> T27
T08 -> T28
(T08, T18) -> T29
```

## まず着手する順番（推奨）

1. T01〜T05（基盤） ✅
2. T06 + T06a（アルバム一覧 + 招待コード）✅
3. T06b（参加リクエスト + 承認フロー）✅
4. T07〜T10（主要画面の実データ化 + オーナー権限UI）✅
5. T11〜T14（運用品質）
6. T15〜T18（最適化・自動化）

## T06b 詳細設計

### 方針

- 招待コードを持っていないユーザーでも、公開アルバムに「参加リクエスト」を送れる
- リクエストは `album_members` テーブルの `membership_status = 'pending'` として保存
- アルバムオーナーはリクエスト一覧を確認し、承認（active）/ 拒否（rejected）できる
- 承認されたユーザーは通常メンバーとしてアルバムに参加

### DB変更

既存の `album_members.membership_status` を活用（`pending` / `active` / `rejected`）。
新規カラム追加は不要（スキーマ変更なし）。

### 参加リクエストフロー

```
検索 → アルバム発見 → 「招待コードを入力」ダイアログ
  → コード入力 → 即参加（既存T06aフロー）
  → 「コードを持っていない」リンク → 参加リクエスト送信
    → membership_status = 'pending' で保存
    → 「リクエスト送信済み」表示
```

### オーナー承認フロー

```
アルバム詳細 → メンバータブ → 未承認リクエスト一覧
  → 承認ボタン → membership_status = 'active' に更新
  → 拒否ボタン → membership_status = 'rejected' に更新（またはレコード削除）
```

### 実装スコープ

1. `lib/supabase/albums.ts` に `requestJoinAlbum()`, `getPendingRequests()`, `approveRequest()`, `rejectRequest()` 追加
2. `app/albums/actions.ts` に対応する Server Actions 追加
3. 招待コード入力ダイアログに「コードを持っていない」リンク追加
4. オーナー向けリクエスト承認UI（T07のメンバータブで本格実装、ここでは最小限）

## ハードコード（モックデータ）一覧と対応タスク

各ファイルのモックデータがどのタスクで本番化されるかのマッピング。

| ファイル | モックデータ内容 | 対応タスク |
|---|---|---|
| `components/ios-navigation.tsx` | TopBarプロフィール「田中太郎」、アバター画像 | **T12** |
| `components/ios-navigation.tsx` | モック検索結果（アルバム/人/イベント） | **T11** |
| `components/ios-navigation.tsx` | モック通知データ（5件ハードコード） | **T12b** |
| `components/member-list.tsx` | ~~メンバー12名のハードコード配列~~ | ~~**T07**~~ ✅ |
| `components/album-grid.tsx` | ~~モックメディア6件（画像パス/views/likes）~~ | ~~**T07, T08**~~ ✅ T07で完了 |
| `components/album-branch-tree.tsx` | ~~モックイベントツリー（入学式/式典等）~~ | ~~**T07**~~ ✅ |
| `components/activity-timeline.tsx` | モックアクティビティフィード6件 | **T19** |
| `components/tsunagu-points-carousel.tsx` | ~~モックアルバムポイント5件~~ | ~~**T20**~~ ✅ |
| `components/tsunagu-mini-card.tsx` | ~~ハードコードポイント値（347/500）~~ | ~~**T20**~~ ✅ T10で完了 |
| `components/connection-graph.tsx` | ~~モック接続メトリクス/ポイント履歴~~ | ~~**T20**~~ ✅ T10で完了 |
| `components/invitation-detail.tsx` | モック招待状詳細（会場/予算等） | **T09** |
| `components/invitation-letters.tsx` | モック招待状一覧2件 | **T09** |
| `components/ai-reunion-proposal.tsx` | モックAI同窓会提案2件 | **T21** |
| `components/user-profile.tsx` | モックユーザープロフィール | **T22** |
| `app/album/[id]/page.tsx` | ~~ハードコードアルバム12件の`albumsData`~~ | ~~**T07**~~ ✅ |
| `app/album/[id]/connections/page.tsx` | ~~重複`albumsData`（上と同一データ）~~ | ~~**T10**~~ ✅ T07で完了 |

## 補足

- 本プロジェクトは現状モックデータ中心のため、**「UI追加」より「既存UIのデータ接続」**の方が価値が高い
- 迷った場合は、ユーザーストーリーの主線（ホーム→アルバム→イベント→招待）を優先する
- 写真を扱うため**セキュリティを優先**する。参加制御（T06a）を画面データ化（T07）より先に実装する
