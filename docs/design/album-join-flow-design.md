# アルバム参加フロー設計

## 現状の問題

### 1. 名前検索の曖昧さ

現在の参加フローは「アルバム名で検索 → 結果から選択 → 招待コード入力 or 参加リクエスト」。

**問題点:**
- 同名アルバムが複数存在しうる（「東京大学」で検索 → 何十件ヒット）
- 検索結果に表示されるのは名前・年・人数のみで、どれが自分のアルバムか判断しにくい
- 名前の一意性を強制するとアルバム作成が不便

### 2. 招待コード入力フローの無駄

招待コードを持っているのに「名前で検索 → アルバムを選ぶ → コード入力」の3ステップが必要。
**コードだけで参加できるべき。**

### 3. 参加リクエストの承認負荷

検索 → リクエスト → オーナー承認という流れは、オーナーの負担が大きい。
また、同名アルバムの中から正しいものを選べていない可能性もあり、誤リクエストが発生しやすい。

---

## 前提: deaitoのターゲットユーザー

deaitoは「もう連絡先を知らない昔の仲間と再びつながる」ためのサービス。
参加者は大きく2パターン:

1. **コードを受け取れる人** — 幹事とLINE等で繋がっている。コードで即参加
2. **コードを受け取れない人** — もう連絡手段がない。**自力でアルバムを見つけるしかない**

→ パターン2のために「アルバムを探す」機能は**必要**。ただし名前検索ではなく、正確に特定できる仕組みが必要。

---

## 提案: 2つの参加導線を明確に分離

### 導線A: 招待コードで即参加（コードを持っている人向け）

- アルバム一覧画面に「招待コードで参加」ボタン
- コード入力 → サーバーでアルバムを逆引き → 即参加
- **アルバムを検索する必要なし**

### 導線B: アルバムを探して参加リクエスト（コードを持っていない人向け）

- アルバム一覧画面に「アルバムを探す」ボタン
- **名前ではなく、複合条件で検索**して正しいアルバムを特定
- 見つけたアルバムに参加リクエストを送信 → オーナー承認

### 参加フロー図

```
アルバム一覧
├── [招待コードで参加] ─── コード入力 ─── 即参加（承認不要）
├── [アルバムを探す] ──── 条件検索 ───── リクエスト送信 → オーナー承認
└── [招待通知] ────────── 承諾 ────────── 即参加（承認不要）
```

---

## 導線A: 招待コードで即参加

### 変更点

| 項目 | 現在 | 改善後 |
|---|---|---|
| コード入力 | 検索 → アルバム選択 → コード入力 | **コード直接入力のみ** |
| 必要な情報 | albumId + joinCode | **joinCode のみ** |
| アルバム特定 | クライアント側で指定 | **サーバーでコードから逆引き** |

### UI

```
┌────────────────────────────────────┐
│ 招待コードで参加                      │
│                                    │
│ アルバムの招待コードを入力してください   │
│ ┌────────────────────────┐         │
│ │ a1b2c3d4e5             │         │
│ └────────────────────────┘         │
│                                    │
│ [参加する]                          │
└────────────────────────────────────┘
```

### 技術変更

```typescript
// 新規: コードからアルバムを逆引きして参加
export async function joinAlbumByCode(input: {
  userId: string
  joinCode: string
}): Promise<{ albumId: string; albumName: string }> {
  const { data: album } = await supabaseAdmin
    .from("albums")
    .select("id, name")
    .eq("join_code", input.joinCode.toLowerCase())
    .single()

  if (!album) throw new Error("無効な招待コードです")

  // 既存メンバーシップ確認 → なければ作成
  // ...（現在の joinAlbum のロジックを流用）
}
```

---

## 導線B: アルバム検索 + 参加リクエスト

### 検索の改善: 名前検索 → 複合条件検索

名前だけでは同名アルバムを区別できない。
**カテゴリ・卒業年・地域を組み合わせて絞り込む**ことで特定精度を上げる。

### 検索UI

```
┌────────────────────────────────────┐
│ アルバムを探す                        │
│                                    │
│ アルバム名                           │
│ ┌────────────────────────┐         │
│ │ 東京大学                │         │
│ └────────────────────────┘         │
│                                    │
│ カテゴリ        卒業年               │
│ ┌──────────┐  ┌──────────┐        │
│ │ すべて ▼  │  │ 2015     │        │
│ └──────────┘  └──────────┘        │
│                                    │
│ ┌─ 検索結果 ─────────────────────┐  │
│ │ 東京大学 理学部同窓会            │  │
│ │ 2015年 · 学校 · 東京都 · 24人   │  │
│ │                    [リクエスト]  │  │
│ ├────────────────────────────────┤  │
│ │ 東京大学 サッカー部OB会          │  │
│ │ 2015年 · 部活 · 東京都 · 12人   │  │
│ │                    [リクエスト]  │  │
│ └────────────────────────────────┘  │
└────────────────────────────────────┘
```

### 検索結果に表示する情報の強化

| 項目 | 現在 | 改善後 |
|---|---|---|
| アルバム名 | ✅ | ✅ |
| 卒業年 | ✅ | ✅ |
| メンバー数 | ✅ | ✅ |
| カテゴリ | ❌ | **✅ 追加**（学校/部活/サークル等） |
| 地域 | ❌ | **✅ 追加** |
| オーナー名 | ❌ | **✅ 追加**（知り合いか判断できる） |

### 検索ロジックの変更

```typescript
export async function searchPublicAlbums(
  userId: string,
  filters: {
    query: string          // アルバム名（部分一致）
    category?: string      // カテゴリ絞り込み（任意）
    year?: number          // 卒業年（任意）
  }
)
```

- 名前は部分一致（現状通り）
- カテゴリ・年はオプションのフィルタとして追加
- 検索結果にカテゴリ・地域・オーナー名を含める

### 参加リクエストの扱い

検索 → リクエスト → オーナー承認の流れは**維持**。

理由: コードを持っていない = オーナーとの直接的なつながりがない。
オーナーが「この人は本当に仲間か」を判断する承認ステップは必要。

---

## まとめ: 変更一覧

### 新規実装

| 項目 | 内容 |
|---|---|
| `joinAlbumByCode()` | コードからアルバム逆引き + 参加 |
| コード直接入力ダイアログ | albumId不要、コードだけで参加 |
| 検索フィルタUI | カテゴリ・卒業年のフィルタ追加 |
| 検索結果の情報強化 | カテゴリ・地域・オーナー名を表示 |

### 変更

| 項目 | 内容 |
|---|---|
| アルバム一覧のボタン構成 | 「招待コードで参加」「アルバムを探す」「作成」の3つ |
| 検索結果のアクション | 「参加」→「リクエスト」に変更（コード入力ダイアログを経由しない） |
| `searchPublicAlbums()` | カテゴリ・年フィルタ追加、結果にカテゴリ・地域・オーナー名を含める |

### 削除

| 項目 | 理由 |
|---|---|
| 検索結果からの招待コード入力フロー | 導線Aに統合（コードがあるなら検索不要） |

### 維持

| 項目 | 理由 |
|---|---|
| 参加リクエスト + オーナー承認 | コードなしの人の本人確認として必要 |
| ユーザー招待（メンバー → ユーザー） | 既存メンバーからの直接招待は引き続き有効 |
| 招待コード生成・再生成・コピー | コード共有の基盤として必要 |

---

## 実装ステップ

1. `joinAlbumByCode()` 実装（コードから逆引き参加）
2. アルバム一覧UIリファクタ（招待コード直接入力ダイアログ + ボタン構成変更）
3. 検索UIにフィルタ追加（カテゴリ・卒業年）
4. 検索結果の表示情報強化（カテゴリ・地域・オーナー名）
5. 検索結果のアクションを「リクエスト送信」に直結（コード入力ダイアログを経由しない）
6. 型チェック + 動作確認
